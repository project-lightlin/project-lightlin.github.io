<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Markdown + Mermaid + KaTeX + 代码高亮</title>

  <!-- Showdown -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/1.9.1/showdown.min.js"></script>

  <!-- Mermaid -->
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>

  <!-- Highlight.js（代码高亮）-->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

  <!-- KaTeX -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js"></script>

  <style>
    /* --- 全局样式 --- */
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol"; /* 通用字体栈 */
      color: #24292e; /* 默认文本颜色 */
      background-color: #ffffff; /* *** 修改：全局背景色为白色 *** */
    }

    /* --- 表格样式 --- */
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 1em 0;
      font-size: 0.9em;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    th, td {
      border: 1px solid #e1e4e8;
      padding: 10px 12px;
      text-align: left;
    }

    th {
      background-color: #f6f8fa;
      font-weight: 600;
      color: #24292e;
    }

    tr:nth-child(even) {
      background-color: #f9f9f9;
    }

    tr:hover {
      background-color: #f1f8ff;
    }

    /* --- 代码块（行间代码）样式 --- */
    pre {
      overflow: auto;
      padding: 0.8em;
      border-radius: 6px;
      background-color: #f6f8fa; /* *** 修改：代码块使用浅灰色背景 *** */
      font-family: Consolas, Monaco, "Andale Mono", "Ubuntu Mono", monospace; /* 代码块使用等宽字体 */
      font-size: 0.9em;
      line-height: 1.4;
    }

    pre code {
      display: inline;
      padding: 0;
      margin: 0;
      overflow: visible;
      line-height: inherit;
      word-wrap: normal;
      background-color: transparent; /* 重置代码块内 code 的背景 */
      border: 0;
      box-shadow: none;
    }

    /* --- 行内代码样式 --- */
    code:not(pre > code) {
      font-family: Consolas, Monaco, "Andale Mono", "Ubuntu Mono", monospace; /* 行内代码使用等宽字体 */
      background-color: #f6f8fa; /* *** 修改：行内代码也使用浅灰色背景 *** */
      color: #c7254e; /* 行内代码文字颜色 */
      padding: 0.2em 0.4em;
      margin: 0;
      border-radius: 3px;
      font-size: 85%;
      white-space: nowrap;
    }

    /* --- Mermaid 样式 --- */
    .mermaid { margin: 1em 0; }
    pre > code.language-mermaid { display: none; }

    /* --- Dark Mode 适配 --- */
    @media (prefers-color-scheme: dark) {
      body {
        color: #c9d1d9;
        background: #0d1117; /* *** 暗黑模式下恢复黑色背景 *** */
      }
      th, td {
        border: 1px solid #30363d;
      }
      th {
        background-color: #161b22;
        color: #c9d1d9;
      }
      tr:nth-child(even) {
        background-color: #11171f;
      }
      tr:hover {
        background-color: #1f232a;
      }
      pre {
        background-color: #161b22; /* *** 暗黑模式下，代码块使用稍微深一些的灰色 *** */
      }
      /* 暗黑模式下行内代码的背景和颜色 */
      code:not(pre > code) {
        background-color: #161b22; /* *** 暗黑模式下，行内代码也使用和 pre 相同的灰色 *** */
        color: #f08d49;
      }
    }
  </style>
</head>
<body>
  <div id="markdownContent">加载中...</div>

  <script>
    // 1) 初始化 mermaid
    mermaid.initialize({
      startOnLoad: false,
      securityLevel: 'loose',
      theme: window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'default'
    });

    // 2) Markdown 解析器
    const converter = new showdown.Converter({
      tables: true,
      ghCodeBlocks: true,
      strikethrough: true,
      tasklists: true
    });

    // 带版本的 URL（优先 ?v=xxx，其次时间戳）
    const baseMd = 'homepage.md';
    const urlV = new URLSearchParams(location.search).get('v');
    const bust = urlV ? `v=${encodeURIComponent(urlV)}` : `t=${Date.now()}`;
    const markdownUrl = `${baseMd}${baseMd.includes('?') ? '&' : '?'}${bust}`;

    const markdownContentDiv = document.getElementById('markdownContent');

    fetch(markdownUrl, { cache: 'no-store' })
      .then(resp => resp.ok ? resp.text() : Promise.reject(resp.status))
      .then(markdownText => {
        // 3) Markdown -> HTML
        let processedMarkdownText = markdownText;
        // 对 KaTeX 公式进行预处理
        processedMarkdownText = processedMarkdownText.replace(/\$\$([\s\S]*?)\$\$/g, (match, group1) => {
          const escapedMath = group1.replace(/\\/g, '\\\\');
          return `$$${escapedMath}$$`;
        });
        processedMarkdownText = processedMarkdownText.replace(/\$([^\$].*?[^\$])\$/g, (match, group1) => {
          const escapedMath = group1.replace(/\\/g, '\\\\');
          return `$${escapedMath}$`;
        });

        let html = converter.makeHtml(processedMarkdownText);

        // 4) DOM 化，先处理 mermaid 代码块
        const container = document.createElement('div');
        container.innerHTML = html;

        const codeBlocks = container.querySelectorAll('pre > code.language-mermaid, pre > code.mermaid');
        codeBlocks.forEach(codeEl => {
          const preEl = codeEl.parentElement;
          const graphDefinition = codeEl.textContent;
          const mermaidDiv = document.createElement('div');
          mermaidDiv.className = 'mermaid';
          mermaidDiv.textContent = graphDefinition;
          preEl.parentElement.replaceChild(mermaidDiv, preEl);
        });

        // 5) 注入
        markdownContentDiv.innerHTML = '';
        markdownContentDiv.appendChild(container);

        // 6) Mermaid 渲染
        mermaid.run({ querySelector: '.mermaid' });

        // 7) 代码高亮
        markdownContentDiv.querySelectorAll('pre code').forEach(block => {
          if (block.classList.contains('language-mermaid') || block.classList.contains('mermaid')) return;
          hljs.highlightElement(block);
        });

        // 8) KaTeX 渲染（行内与块级）
        if (window.renderMathInElement) {
          renderMathInElement(markdownContentDiv, {
            delimiters: [
              {left: "$$", right: "$$", display: true},
              {left: "\\[", right: "\\]", display: true},
              {left: "$", right: "$", display: false},
              {left: "\\(", right: "\\)", display: false},
            ],
            throwOnError: false,
            strict: "warn",
            ignoredTags: ["script","noscript","style","textarea","pre","code"],
            trust: false,
            macros: {
              "\\RR": "\\mathbb{R}",
              "\\NN": "\\mathbb{N}"
            }
          });
        }
      })
      .catch(err => {
        markdownContentDiv.textContent = '加载失败：' + err;
      });
  </script>
</body>
</html>
