<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Markdown + Mermaid + KaTeX + 代码高亮</title>

  <!-- Showdown -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/1.9.1/showdown.min.js"></script>

  <!-- Mermaid -->
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>

  <!-- Highlight.js（代码高亮）-->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

  <!-- KaTeX -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js"></script>

  <style>
    .mermaid { margin: 1em 0; }
    pre > code.language-mermaid { display: none; }
    pre code { white-space: pre; }
    pre { overflow: auto; padding: 0.8em; border-radius: 6px; background: #f6f8fa; }
    @media (prefers-color-scheme: dark) {
      body { color: #ddd; background: #0b0d11; }
      pre { background: #0e1116; }
    }
  </style>
</head>
<body>
  <div id="markdownContent">加载中...</div>

  <script>
    // 1) 初始化 mermaid
    mermaid.initialize({
      startOnLoad: false,
      securityLevel: 'loose',
      theme: window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'default'
    });

    // 2) Markdown 解析器
    const converter = new showdown.Converter({
      tables: true,
      ghCodeBlocks: true,
      strikethrough: true,
      tasklists: true
    });

    // 带版本的 URL（优先 ?v=xxx，其次时间戳）
    const baseMd = 'homepage.md';
    const urlV = new URLSearchParams(location.search).get('v');
    const bust = urlV ? `v=${encodeURIComponent(urlV)}` : `t=${Date.now()}`;
    const markdownUrl = `${baseMd}${baseMd.includes('?') ? '&' : '?'}${bust}`;

    const markdownContentDiv = document.getElementById('markdownContent');

    fetch(markdownUrl, { cache: 'no-store' })
      .then(resp => resp.ok ? resp.text() : Promise.reject(resp.status))
      .then(markdownText => {
        // 3) Markdown -> HTML
        // *** 核心修改：对 KaTeX 公式进行预处理 ***
        let processedMarkdownText = markdownText;
        // 查找 $$...$$ 块级公式
        processedMarkdownText = processedMarkdownText.replace(/\$\$([\s\S]*?)\$\$/g, (match, group1) => {
          // 在公式内部，将 \ 替换为 \\
          const escapedMath = group1.replace(/\\/g, '\\\\');
          return `$$${escapedMath}$$`;
        });
        // 查找 $...$ 行内公式 (如果你的 Markdown 中也使用了行内公式)
        processedMarkdownText = processedMarkdownText.replace(/\$([^\$].*?[^\$])\$/g, (match, group1) => {
           // 在公式内部，将 \ 替换为 \\
          const escapedMath = group1.replace(/\\/g, '\\\\');
          return `$${escapedMath}$`;
        });


        let html = converter.makeHtml(processedMarkdownText);

        // 4) DOM 化，先处理 mermaid 代码块
        const container = document.createElement('div');
        container.innerHTML = html;

        const codeBlocks = container.querySelectorAll('pre > code.language-mermaid, pre > code.mermaid');
        codeBlocks.forEach(codeEl => {
          const preEl = codeEl.parentElement;
          const graphDefinition = codeEl.textContent;
          const mermaidDiv = document.createElement('div');
          mermaidDiv.className = 'mermaid';
          mermaidDiv.textContent = graphDefinition;
          preEl.parentElement.replaceChild(mermaidDiv, preEl);
        });

        // 5) 注入
        markdownContentDiv.innerHTML = '';
        markdownContentDiv.appendChild(container);

        // 6) Mermaid 渲染
        mermaid.run({ querySelector: '.mermaid' });

        // 7) 代码高亮
        markdownContentDiv.querySelectorAll('pre code').forEach(block => {
          if (block.classList.contains('language-mermaid') || block.classList.contains('mermaid')) return;
          hljs.highlightElement(block);
        });

        // 8) KaTeX 渲染（行内与块级）
        if (window.renderMathInElement) {
          renderMathInElement(markdownContentDiv, {
            delimiters: [
              {left: "$$", right: "$$", display: true},
              {left: "\\[", right: "\\]", display: true},
              {left: "$", right: "$", display: false},
              {left: "\\(", right: "\\)", display: false},
            ],
            throwOnError: false,
            strict: "warn",
            // 确保 <pre><code> 标签中的 KaTeX 不被渲染，因为它们通常是代码示例
            ignoredTags: ["script","noscript","style","textarea","pre","code"],
            trust: false,
            macros: {
              "\\RR": "\\mathbb{R}",
              "\\NN": "\\mathbb{N}"
            }
          });
        }
      })
      .catch(err => {
        markdownContentDiv.textContent = '加载失败：' + err;
      });
  </script>
</body>
</html>
